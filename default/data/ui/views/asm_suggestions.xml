<dashboard version="1.1">
  <label>Tenable ASM â€“ Suggestions</label>
  <description>
    Visibility into Tenable Attack Surface Management suggestions, types, and rule complexity.
  </description>

  <!-- ========================= -->
  <!-- Suggestion Counts -->
  <!-- ========================= -->
  <row>

    <panel>
      <title>Total Suggestions</title>
      <single>
        <search>
          <query>
            index=$ASM_INDEX$ sourcetype=tenable:asm:suggestions
            | stats dc(id) as total
          </query>
        </search>
        <option name="drilldown">none</option>
      </single>
    </panel>

    <panel>
      <title>Active Suggestions</title>
      <single>
        <search>
          <query>
            index=$ASM_INDEX$ sourcetype=tenable:asm:suggestions
            | eval deleted_at=coalesce(deleted_at,"")
            | where deleted_at=""
            | stats dc(id) as active
          </query>
        </search>
        <option name="drilldown">none</option>
      </single>
    </panel>

    <panel>
      <title>Archived Suggestions</title>
      <single>
        <search>
          <query>
            index=$ASM_INDEX$ sourcetype=tenable:asm:suggestions
            | eval deleted_at=coalesce(deleted_at,"")
            | where deleted_at!=""
            | stats dc(id) as archived
          </query>
        </search>
        <option name="drilldown">none</option>
      </single>
    </panel>

  </row>

  <!-- ========================= -->
  <!-- Suggestion Type Distribution -->
  <!-- ========================= -->
  <row>
    <panel>
      <title>Suggestions by Type</title>
      <chart>
        <search>
          <query>
            index=$ASM_INDEX$ sourcetype=tenable:asm:suggestions
            | eval suggestion_type=coalesce(suggestion_type,"unknown")
            | stats count as count by suggestion_type
            | sort - count
          </query>
        </search>
        <option name="charting.chart">bar</option>
        <option name="charting.axisTitleX.text">Suggestion Type</option>
        <option name="charting.axisTitleY.text">Count</option>
        <option name="drilldown">none</option>
      </chart>
    </panel>
  </row>

  <!-- ========================= -->
  <!-- Rules per Suggestion Distribution -->
  <!-- ========================= -->
  <row>
    <panel>
      <title>Rules per Suggestion (Distribution)</title>
      <chart>
        <search>
          <query>
            index=$ASM_INDEX$ sourcetype=tenable:asm:suggestions
            | spath path=suggestion_details.rules{} output=rules_mv
            | eval rule_count=mvcount(rules_mv)
            | stats count as suggestions by rule_count
            | sort 0 + rule_count
          </query>
        </search>
        <option name="charting.chart">column</option>
        <option name="charting.axisTitleX.text">Rule Count</option>
        <option name="charting.axisTitleY.text">Suggestions</option>
        <option name="drilldown">none</option>
      </chart>
    </panel>
  </row>

  <!-- ========================= -->
  <!-- Rules Summary Stats -->
  <!-- ========================= -->
  <row>
    <panel>
      <title>Rule Count Summary (Avg / Min / Max)</title>
      <table>
        <search>
          <query>
            index=$ASM_INDEX$ sourcetype=tenable:asm:suggestions
            | spath path=suggestion_details.rules{} output=rules_mv
            | eval rule_count=mvcount(rules_mv)
            | stats avg(rule_count) as avg_rules min(rule_count) as min_rules max(rule_count) as max_rules
          </query>
        </search>
        <option name="wrap">true</option>
        <option name="drilldown">none</option>
        <option name="count">1</option>
        <option name="export.menu">true</option>
      </table>
    </panel>
  </row>

  <!-- ========================= -->
  <!-- Suggestion Details -->
  <!-- ========================= -->
  <row>
    <panel>
      <title>Suggestion Details</title>
      <table>
        <search>
          <query>
            index=$ASM_INDEX$ sourcetype=tenable:asm:suggestions
            | eval deleted_at=coalesce(deleted_at,"")
            | eval status=if(deleted_at="","active","archived")
            | spath path=suggestion_details.rules{} output=rules_mv
            | eval rule_count=mvcount(rules_mv)
            | eval rules_preview=mvjoin(rules_mv," | ")
            | table id suggestion_type suggestion_text status created_at deleted_at rule_count rules_preview
            | sort - created_at
          </query>
        </search>
        <option name="count">25</option>
        <option name="wrap">true</option>
        <option name="drilldown">none</option>
        <option name="export.menu">true</option>
      </table>
    </panel>
  </row>

</dashboard>
