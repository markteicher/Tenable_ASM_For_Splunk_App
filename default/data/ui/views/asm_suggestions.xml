<dashboard version="1.1">
  <label>Tenable ASM â€“ Suggestions</label>
  <description>
    Suggestions and rule breakdown from indexed ASM suggestion events.
  </description>

  <fieldset submitButton="false">

    <input type="dropdown" token="tok_archived">
      <label>Archived</label>
      <choice value="*">All</choice>
      <choice value="false">Active</choice>
      <choice value="true">Archived</choice>
      <default>*</default>
    </input>

    <input type="dropdown" token="tok_type">
      <label>Suggestion Type</label>
      <choice value="*">All</choice>
      <default>*</default>
      <prefix>suggestion_type="</prefix>
      <suffix>"</suffix>
      <search>
        <query>
          index=$ASM_INDEX$ sourcetype=tenable:asm:suggestions
          | stats count by suggestion_type
          | sort suggestion_type
        </query>
      </search>
      <fieldForLabel>suggestion_type</fieldForLabel>
      <fieldForValue>suggestion_type</fieldForValue>
    </input>

    <input type="text" token="tok_text">
      <label>Search Suggestion Text</label>
      <default>*</default>
    </input>

  </fieldset>

  <!-- ========================= -->
  <!-- Summary -->
  <!-- ========================= -->
  <row>
    <panel>
      <title>Total Suggestions</title>
      <single>
        <search>
          <query>
            index=$ASM_INDEX$ sourcetype=tenable:asm:suggestions
            | stats dc(id)
          </query>
        </search>
        <option name="drilldown">none</option>
      </single>
    </panel>

    <panel>
      <title>Active Suggestions</title>
      <single>
        <search>
          <query>
            index=$ASM_INDEX$ sourcetype=tenable:asm:suggestions
            | where isnull(deleted_at) OR deleted_at=""
            | stats dc(id)
          </query>
        </search>
        <option name="drilldown">none</option>
      </single>
    </panel>

    <panel>
      <title>Archived Suggestions</title>
      <single>
        <search>
          <query>
            index=$ASM_INDEX$ sourcetype=tenable:asm:suggestions
            | where isnotnull(deleted_at) AND deleted_at!=""
            | stats dc(id)
          </query>
        </search>
        <option name="drilldown">none</option>
      </single>
    </panel>
  </row>

  <!-- ========================= -->
  <!-- Suggestions Table -->
  <!-- ========================= -->
  <row>
    <panel>
      <title>Suggestions</title>
      <table>
        <search>
          <query>
            index=$ASM_INDEX$ sourcetype=tenable:asm:suggestions
            | eval is_archived=if(isnotnull(deleted_at) AND deleted_at!="","true","false")
            | where ("$tok_archived$"="*" OR is_archived="$tok_archived$")
            | search $tok_type$
            | eval suggestion_text=coalesce(suggestion_text, suggestion_title)
            | eval _match=if("$tok_text$"="*" OR "$tok_text$"="", 1, like(lower(suggestion_text), "%".lower("$tok_text$")."%"))
            | where _match=1
            | stats
                latest(suggestion_text) as suggestion_text
                latest(suggestion_type) as suggestion_type
                latest(created_at) as created_at
                latest(deleted_at) as deleted_at
                latest(is_archived) as is_archived
              by id
            | table id suggestion_text suggestion_type is_archived created_at deleted_at
          </query>
        </search>
        <option name="count">20</option>
        <option name="wrap">true</option>
        <option name="drilldown">none</option>
        <option name="export.menu">true</option>
      </table>
    </panel>
  </row>

  <!-- ========================= -->
  <!-- Rule Breakdown -->
  <!-- ========================= -->
  <row>
    <panel>
      <title>Suggestion Rules</title>
      <table>
        <search>
          <query>
            index=$ASM_INDEX$ sourcetype=tenable:asm:suggestions
            | eval is_archived=if(isnotnull(deleted_at) AND deleted_at!="","true","false")
            | where ("$tok_archived$"="*" OR is_archived="$tok_archived$")
            | search $tok_type$
            | eval suggestion_text=coalesce(suggestion_text, suggestion_title)
            | spath input=suggestion_details.rules
            | mvexpand suggestion_details.rules
            | spath input=suggestion_details.rules path=rule output=rule
            | spath input=suggestion_details.rules path=description output=description
            | table id suggestion_text suggestion_type rule description
          </query>
        </search>
        <option name="count">20</option>
        <option name="wrap">true</option>
        <option name="drilldown">none</option>
        <option name="export.menu">true</option>
      </table>
    </panel>
  </row>

</dashboard>
