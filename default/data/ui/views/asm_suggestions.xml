<dashboard version="1.1">
  <label>Tenable ASM – Subscriptions</label>
  <description>
    Smart Folders (Subscriptions): counts, asset coverage, filter complexity, and detailed listing.
  </description>

  <!-- ========================= -->
  <!-- Key Counts -->
  <!-- ========================= -->
  <row>
    <panel>
      <title>Total Subscriptions</title>
      <single>
        <search>
          <query>
            index=$ASM_INDEX$ sourcetype=tenable:asm:subscriptions
            | stats dc(id) as total_subscriptions
          </query>
        </search>
        <option name="drilldown">none</option>
      </single>
    </panel>

    <panel>
      <title>Total Assets Covered</title>
      <single>
        <search>
          <query>
            index=$ASM_INDEX$ sourcetype=tenable:asm:subscriptions
            | stats sum(current_asset_count) as total_assets_covered
          </query>
        </search>
        <option name="drilldown">none</option>
      </single>
    </panel>

    <panel>
      <title>Subscriptions With Filters</title>
      <single>
        <search>
          <query>
            index=$ASM_INDEX$ sourcetype=tenable:asm:subscriptions
            | eval has_filters=if(isnull(filters_normalized) OR trim(filters_normalized)="", 0, 1)
            | stats sum(has_filters) as subscriptions_with_filters
          </query>
        </search>
        <option name="drilldown">none</option>
      </single>
    </panel>
  </row>

  <!-- ========================= -->
  <!-- Distributions -->
  <!-- ========================= -->
  <row>
    <panel>
      <title>Subscriptions by Asset Count</title>
      <chart>
        <search>
          <query>
            index=$ASM_INDEX$ sourcetype=tenable:asm:subscriptions
            | eval asset_bucket=case(
                current_asset_count>=10000,"10k+",
                current_asset_count>=5000,"5k–9,999",
                current_asset_count>=1000,"1k–4,999",
                current_asset_count>=100,"100–999",
                current_asset_count>=1,"1–99",
                1=1,"0"
              )
            | stats count as subscriptions by asset_bucket
            | sort 0 asset_bucket
          </query>
        </search>
        <option name="charting.chart">column</option>
        <option name="charting.axisTitleX.text">Asset Count Bucket</option>
        <option name="charting.axisTitleY.text">Subscriptions</option>
        <option name="drilldown">none</option>
      </chart>
    </panel>

    <panel>
      <title>Filter Complexity</title>
      <chart>
        <search>
          <query>
            index=$ASM_INDEX$ sourcetype=tenable:asm:subscriptions
            | eval f=trim(filters_normalized)
            | eval filter_count=case(
                isnull(f) OR f="", 0,
                like(f,"% AND %"), mvcount(split(f," AND "))+1,
                1=1, 1
              )
            | stats count as subscriptions by filter_count
            | sort 0 filter_count
          </query>
        </search>
        <option name="charting.chart">bar</option>
        <option name="charting.axisTitleX.text">Subscriptions</option>
        <option name="charting.axisTitleY.text">Filter Count</option>
        <option name="drilldown">none</option>
      </chart>
    </panel>
  </row>

  <!-- ========================= -->
  <!-- Subscription Details -->
  <!-- ========================= -->
  <row>
    <panel>
      <title>Subscription Details</title>
      <table>
        <search>
          <query>
            index=$ASM_INDEX$ sourcetype=tenable:asm:subscriptions
            | eval f=trim(filters_normalized)
            | eval filter_count=case(
                isnull(f) OR f="", 0,
                like(f,"% AND %"), mvcount(split(f," AND "))+1,
                1=1, 1
              )
            | table id name current_asset_count filter_count filters_normalized updated_at description
            | sort - updated_at
          </query>
        </search>
        <option name="count">25</option>
        <option name="wrap">true</option>
        <option name="drilldown">none</option>
        <option name="rowNumbers">false</option>
      </table>
    </panel>
  </row>

</dashboard>
